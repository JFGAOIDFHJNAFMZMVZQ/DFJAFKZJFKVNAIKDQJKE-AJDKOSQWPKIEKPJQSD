local HttpService = game:GetService("HttpService")
local Players     = game:GetService("Players")
local MarketplaceService = game:GetService("MarketplaceService")
local Stats       = game:GetService("Stats")
local UserInputService = game:GetService("UserInputService")

local module = {}

-- function to identify exploiter
local function safeIdentifyExecutor()
    local exec = "Unknown"
    pcall(function()
        if identifyexecutor then
            exec = identifyexecutor()
        end
    end)
    return exec
end

-- get a working http request function
local function getHttpRequest()
    local g = getgenv()
    return 
        (syn and syn.request)
        or g.syn and g.syn.request
        or request
        or http_request
        or (http and http.request)
        or g.http_request
end

module.SendInitLog = function(success, errmsg)
    local url = getgenv().devwareWebhookUrl
    if not url or url == "" then return end

    local http = getHttpRequest()
    if not http then return end

    if success and getgenv().devwareLogSuccess == false then
        return
    end

    local player = Players.LocalPlayer
    local now = os.date("%Y-%m-%d %H:%M:%S")

    local userid      = player.UserId
    local username    = player.Name
    local displayName = player.DisplayName
    local accountAge  = player.AccountAge

    local gameInfo = MarketplaceService:GetProductInfo(game.PlaceId)

    local body = {
        content = "```" ..
        "Devware Init " .. (success and "SUCCESS" or "ERROR") .. "\n" ..
        "Script: " .. tostring(getgenv().devwareScriptName) .. "\n" ..
        "Time: " .. now .. "\n" ..
        "User: " .. username .. " (" .. userid .. ")\n" ..
        "Game: " .. gameInfo.Name .. "\n" ..
        (errmsg and ("Error: "..errmsg.."\n") or "") ..
        "```"
    }

    http({
        Url = url,
        Method = "POST",
        Headers = { ["Content-Type"] = "application/json" },
        Body = HttpService:JSONEncode(body)
    })
end

return module
